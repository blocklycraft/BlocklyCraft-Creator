<!DOCTYPE html>
<html lang="zh_cn" style="height: 100%; width: 100%;margin: 0;">
<head>
    <meta charset="UTF-8">
    <title>BlocklyEditor</title>
</head>
<body  style="height: 100%; width: 100%;margin: 0;">
<div id="blocklyDiv" style="height: 100%; width: 100%;"></div>

<script src="blockly_compressed.js"></script>

<script src="msg/js/zh-hans.js"></script>
<script>
    function init() {
        //加载库
        const { app } = require('electron').remote;
        const fs = require('fs');
        const Lib = {};
        let Toolbar = "";
        console.log(app.getAppPath());


        if(!fs.existsSync(app.getPath("appData")+"/BlockCreator"+"/libraries")){
            fs.mkdirSync(app.getPath("appData")+"/BlockCreator"+"/libraries");
            console.log("[DB] 文件夹不存在，创建中.....");
        }
        let libfiles = fs.readdirSync(app.getPath("appData")+"/BlockCreator"+"/libraries");
        let dirs = libfiles.filter(item => {
            return fs.statSync(app.getPath("appData")+"/BlockCreator"+"/libraries/"+item).isDirectory()
        });
        for (let dir of dirs){
            //检查是否存在library.json,此文件是扩展库的清单文件
            let lib_root = app.getPath("appData")+"/BlockCreator"+"/libraries/"+dir;
            if(!fs.existsSync(lib_root+"/library.json")){
                console.log(lib_root+"/library.json Not Found,Ignore this Directory...");
                continue;
            }
            let lib_inf;
            lib_inf = JSON.parse(fs.readFileSync(lib_root + "/library.json", "utf8"));
            console.log(lib_inf);
            Lib[lib_inf.name]=lib_root;

            //加载块
            if(fs.existsSync(lib_root+"/blocks.json")){
                let blocks = JSON.parse(fs.readFileSync(lib_root+"/blocks.json","utf8"));
                for (let block of blocks){
                    console.log("REGISTER:"+block.type);
                    Blockly.Blocks[block.type] = {
                        init: function() {
                            this.jsonInit(block);
                        }
                    };
                }
            }
            //加载工具栏
            if(fs.existsSync(lib_root+"/toolbar.xml")){
                let lib_toolbar = fs.readFileSync(lib_root+"/toolbar.xml","utf8");
                Toolbar += lib_toolbar;
            }
            //加载代码生成器
            if(fs.existsSync(lib_root+"/generator.js")){
                let code_gen = fs.readFileSync(lib_root+"/generator.js","utf8");
                eval(code_gen);
            }
        }
        Toolbar = '<xml>' + Toolbar + '</xml>';

        let workspace = Blockly.inject('blocklyDiv',
            {toolbox: Toolbar});
    }

</script>

</body>
</html>